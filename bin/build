#!/bin/bash

set -o errexit
set -o pipefail

export PATH="/usr/local/bin:/usr/bin:/bin:$GOROOT/bin"

# args
PROJECT=$1
echo "Project $PROJECT"

# determine root
root=$(cd $(dirname $0); pwd)

gopath=$(mktemp -d tmp/goroot_XXXX)
echo "Created GOPATH($gopath)"
trap 'echo Cleaning; rm -fr $gopath' EXIT
export GOPATH="$gopath"


echo "Downlaoding $PROJECT"
go get -d "$PROJECT"

# clone the specified ref
cd $GOPATH/src/$PROJECT
if [[ ! -z $REF ]]; then
	git fetch origin
	git checkout $REF
fi

echo "Setting version to $VERSION"
# FIXME: todo

echo "Compiling"
go install

if [ -d $GOPATH/bin/${GOOS}_${GOARCH} ]; then
	BINARY="$(ls -1 $GOPATH/bin/${GOOS}_${GOARCH}/$(echo $PROJECT | cut -d/ -f3)*)"
else
	BINARY="$GOPATH/bin/$(echo $PROJECT | cut -d/ -f3)"
fi

echo "Uploading binary(FIXME)"
#addr=$(cat "$root/app.ini" | grep "^serverAddr" | awk -F: '{print "127.0.0.1:" $2}' | xargs echo -n)
#curl -s -d "p=$path" -d "sha=$SHA" $addr/api/update
curl $BUILD_HOST/api/$BUILD_ID/finish

